<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>小遊戲</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* 頁面背景與上方固定元素（維持你原本設定） */
    body {
      margin: 0;
      height: 100vh;
      width: 100vw;
      background: url("picture/background.png") no-repeat center center;
      background-size: cover;
      overflow: hidden;
    }
    #game { width: 100%; height: 100%; position: relative; }

    /* 兩個上方資訊框的位置 */
    .info { position: absolute; top: 2%; width: 350px; height: auto; }
    #time { left: 4%; }
    #score { right: 20%; }

    .info > img { width: 100%; height: auto; display: block; }
    .info .label {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      white-space: nowrap; gap: 40px;
      font-size: 36px; font-weight: 500; color: #000;
      pointer-events: none; padding: 0 8px;
    }

    /* 左右兩個 block 的水平位置（維持你原本設定） */
    #block1 { left: 3%; }
    #block2 { right: 3%; }

    /* 底部角色（維持你原本設定） */
    .character { position: absolute; bottom: 2%; width: 180px; height: auto; }
    #boy1, #boy3 { left: 0%; }
    #truck { left: 50%; transform: translateX(-50%); }
    #girl1, #girl3 { right: 0%; }
  </style>
</head>

<body>
  <div id="game">
    <!-- 左側作答區 -->
    <div id="block1" class="block">
      <img src="picture/block1.png" alt="Block 1" />
      <div class="block-slot">
        <div class="block-text" id="block1-text"></div>
        <div class="block-subtext" id="block1-subtext"></div>

        <!-- 覆蓋層：放按鈕（不影響文字排版） -->
        <div class="ui-overlay">
          <!-- 縣市旁：直轄市 / 縣 / 省轄市（同組只能選一） -->
          <div class="btn-row city-row" style="--x:12%; --y:235%;" role="group" aria-label="城市層級">
            <button class="gbtn" aria-pressed="false">直轄市</button>
            <button class="gbtn gbtn-small" aria-pressed="false">縣</button>
            <button class="gbtn" aria-pressed="false">省轄市</button>
          </div>
          <!-- 鄉鎮市區旁：鄉 / 鎮 / 市 / 區（同組只能選一） -->
          <div class="btn-row dist-row" style="--x:12%; --y:305%;" role="group" aria-label="區鄉鎮層級">
            <button class="gbtn gbtn-small" aria-pressed="false">鄉</button>
            <button class="gbtn gbtn-small" aria-pressed="false">鎮</button>
            <button class="gbtn gbtn-small" aria-pressed="false">市</button>
            <button class="gbtn gbtn-small" aria-pressed="false">區</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 右側作答區 -->
    <div id="block2" class="block">
      <img src="picture/block2.png" alt="Block 2" />
      <div class="block-slot">
        <div class="block-text" id="block2-text"></div>
        <div class="block-subtext" id="block2-subtext"></div>

        <!-- 覆蓋層：放按鈕（不影響文字排版） -->
        <div class="ui-overlay">
          <div class="btn-row city-row" style="--x:-8%; --y:235%;" role="group" aria-label="城市層級">
            <button class="gbtn" aria-pressed="false">直轄市</button>
            <button class="gbtn gbtn-small" aria-pressed="false">縣</button>
            <button class="gbtn" aria-pressed="false">省轄市</button>
          </div>
          <div class="btn-row dist-row" style="--x:-8%; --y:305%;" role="group" aria-label="區鄉鎮層級">
            <button class="gbtn gbtn-small" aria-pressed="false">鄉</button>
            <button class="gbtn gbtn-small" aria-pressed="false">鎮</button>
            <button class="gbtn gbtn-small" aria-pressed="false">市</button>
            <button class="gbtn gbtn-small" aria-pressed="false">區</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 上方資訊框 -->
    <div id="time" class="info">
      <img src="picture/time.png" alt="Time" />
      <span class="label">
        <span class="text-left">時間 ⌛</span>
        <span class="text-right" id="timeValue">05:00</span>
      </span>
    </div>

    <div id="score" class="info">
      <img src="picture/score.png" alt="Score" />
      <span class="label">
        <span class="text-left">分數 ⭐</span>
        <span class="text-right" id="scoreValue">0</span>
      </span>
    </div>

    <!-- 底部角色 -->
    <img id="boy1" class="character" src="picture/boy1.png" alt="Boy 1" />
    <img id="boy3" class="character hidden" src="picture/boy3.png" alt="Boy 3" />

    <img id="truck" class="character" src="picture/truck.png" alt="Truck" />

    <img id="girl1" class="character" src="picture/girl1.png" alt="Girl 1" />
    <img id="girl3" class="character hidden" src="picture/girl3.png" alt="Girl 3" />
  </div>

  <script>
    const CITY_WEIGHTS = {
  '新北市': 0.2,
  '臺北市': 0.2,
  '高雄市': 0.5,
  '臺中市': 0.5,
  '臺南市': 0.5,
  '新竹市': 5,
  '基隆市': 5,
  '嘉義市': 5,
  '連江縣': 12,
  '澎湖縣': 10,
  '金門縣': 10,
  '新竹縣': 4,
  '嘉義縣': 4,
  '彰化縣': 2,
  '雲林縣': 2,
  '花蓮縣': 2,
  '宜蘭縣': 2,
  '南投縣': 2,
  '苗栗縣': 2,
  '屏東縣': 2,
  '臺東縣': 2,
};
    // ====== 狀態變數（不可少）======
    let currentScore = 0;      // 目前分數
    let rec1 = null;           // block1 題目
    let rec2 = null;           // block2 題目
    let isSubmitting = false;  // 送分中的 1 秒鎖定
    let dataset = null;        // 資料集

    /* ===== 工具 ===== */
    function weightedRandomPick(data) {
  // 計算總權重
  let totalWeight = 0;
  const weights = data.map(rec => {
    const w = CITY_WEIGHTS[rec.縣市] || 1; // 沒定義的縣市，預設權重=1
    totalWeight += w;
    return w;
  });

  // 取一個 [0, totalWeight) 的隨機數
  let r = Math.random() * totalWeight;
  for (let i = 0; i < data.length; i++) {
    r -= weights[i];
    if (r <= 0) return data[i];
  }
  // 理論上不會到這裡
  return data[data.length - 1];
}

    function trimSuffix(text){ const s=["市","區","縣","鄉","鎮"]; const c=text.slice(-1); return s.includes(c)?text.slice(0,-1):text; }
    function keepLastTogether(text,n=2){ if(!text||text.length<=n) return text; const h=text.slice(0,-n), t=text.slice(-n); return h+'<span class="no-break">'+t+'</span>'; }
    const SPECIAL_MUNIS=new Set(["臺北市","新北市","桃園市","臺中市","臺南市","高雄市"]);
    function classifyCityType(name){ const k=name.slice(-1); if(k==="縣")return"縣"; if(k==="市")return SPECIAL_MUNIS.has(name)?"直轄市":"省轄市"; return "未知"; }
    function classifyDistrictType(d){ const k=d.slice(-1); return ["鄉","鎮","市","區"].includes(k)?k:"未知"; }

    const truckEl=document.getElementById("truck");
    const scoreEl=document.getElementById("scoreValue");
    const timeEl=document.getElementById("timeValue");

    function getSelections(){
      const b1CitySel=document.querySelector("#block1 .city-row .gbtn.is-active")?.textContent?.trim();
      const b1DistSel=document.querySelector("#block1 .dist-row .gbtn.is-active")?.textContent?.trim();
      const b2CitySel=document.querySelector("#block2 .city-row .gbtn.is-active")?.textContent?.trim();
      const b2DistSel=document.querySelector("#block2 .dist-row .gbtn.is-active")?.textContent?.trim();
      return {b1CitySel,b1DistSel,b2CitySel,b2DistSel};
    }
    function allFourSelected(){ const {b1CitySel,b1DistSel,b2CitySel,b2DistSel}=getSelections(); return Boolean(b1CitySel&&b1DistSel&&b2CitySel&&b2DistSel); }
    function updateTruckInteractivity(){ if(isSubmitting||!allFourSelected()){ truckEl.classList.add("disabled"); truckEl.setAttribute("aria-disabled","true"); } else { truckEl.classList.remove("disabled"); truckEl.setAttribute("aria-disabled","false"); } }

    function setupSingleSelectRow(row){
      if(!row) return;
      row.addEventListener("click",(e)=>{
        const btn=e.target.closest("button.gbtn"); if(!btn||!row.contains(btn)||isSubmitting||timeOver) return;
        row.querySelectorAll("button.gbtn").forEach(b=>{ b.classList.remove("is-active"); b.setAttribute("aria-pressed","false"); });
        btn.classList.add("is-active"); btn.setAttribute("aria-pressed","true");
        updateTruckInteractivity();
      });
    }
    function clearSelections(){
      document.querySelectorAll(".city-row .gbtn, .dist-row .gbtn").forEach(b=>{ b.classList.remove("is-active","ok","ng"); b.setAttribute("aria-pressed","false"); });
    }
    function flashJudge(rowSel,chosen,answer){
      const row=document.querySelector(rowSel); if(!row||!chosen) return;
      row.querySelectorAll("button.gbtn").forEach(b=>b.classList.remove("ok","ng"));
      const btn=[...row.querySelectorAll("button.gbtn")].find(b=>b.textContent.trim()===chosen);
      if(!btn) return;
      btn.classList.remove("is-active");   // 先移掉藍色
      btn.classList.add(chosen===answer?"ok":"ng");
      setTimeout(()=>{ btn.classList.remove("ok","ng"); },1000);
    }

    function loadNewRound(data){
      rec1 = weightedRandomPick(data);
      rec2 = weightedRandomPick(data);
      document.getElementById("block1-text").innerHTML = rec1.門市名稱+"："+"<br>"+keepLastTogether(rec1.其餘地址,2);
      document.getElementById("block2-text").innerHTML = rec2.門市名稱+"："+"<br>"+keepLastTogether(rec2.其餘地址,2);
      document.getElementById("block1-subtext").innerHTML = trimSuffix(rec1.縣市)+"<br>"+trimSuffix(rec1.鄉鎮市區);
      document.getElementById("block2-subtext").innerHTML = trimSuffix(rec2.縣市)+"<br>"+trimSuffix(rec2.鄉鎮市區);
      clearSelections(); isSubmitting=false; updateTruckInteractivity();
    }

    /* ===== 計時器 ===== */
    let timeLeft = 5*60;       // 5 分鐘（秒）
    let timerId = null;
    let timeOver = false;

    function formatMMSS(s){ const m=Math.floor(s/60); const ss=String(s%60).padStart(2,"0"); return String(m).padStart(2,"0")+":"+ss; }
    function tick(){
      timeLeft = Math.max(0, timeLeft - 1);
      timeEl.textContent = formatMMSS(timeLeft);
      if (timeLeft <= 0 && !timeOver) { endGame(); }
    }
    function startTimer(){
      timeEl.textContent = formatMMSS(timeLeft);
      timerId = setInterval(tick, 1000);
    }

    function pickEnding(score){
  if (score >= 1000) return "end1";
  if (score >= 800)  return "end2";
  if (score >= 650)  return "end3";
  if (score >= 450)  return "end4";   // ← 若你要 450 以上也是 end2，就改成 "end2"
  return "end5";
}

function endGame(){
  if (timeOver) return;
  timeOver = true;

  if (timerId) clearInterval(timerId);
  isSubmitting = true;
  truckEl.classList.add("disabled");

  ['#block1','#block2','#boy1','#truck','#girl1'].forEach(sel=>{
    const el = document.querySelector(sel);
    if (el) el.classList.add('hidden');
  });

  timeEl.textContent = "00:00";

  // 依最終分數選結局，帶參數 e（不顯示分數）
  const ending = pickEnding(currentScore);
  setTimeout(() => {
    window.location.href = `end.html?e=${ending}`;
  }, 400);
}



    /* ===== 初始化 ===== */
    document.addEventListener("DOMContentLoaded", ()=>{
      document.querySelectorAll(".city-row, .dist-row").forEach(setupSingleSelectRow);
      scoreEl.textContent = currentScore;
    });

    fetch("seven_eleven.json").then(r=>r.json()).then(data=>{
      dataset=data;
      loadNewRound(dataset);
      startTimer(); // 開始倒數
    }).catch(err=>console.error("讀取 JSON 發生錯誤:",err));

    /* ===== 送出答案（卡車） ===== */
    truckEl.addEventListener("click", ()=>{
      if(timeOver) return;                    // 時間到不可再送
      if(isSubmitting || !rec1 || !rec2) return;
      if(!allFourSelected()) return;

      isSubmitting = true; updateTruckInteractivity();

      const {b1CitySel,b1DistSel,b2CitySel,b2DistSel} = getSelections();
      const b1CityAns=classifyCityType(rec1.縣市), b1DistAns=classifyDistrictType(rec1.鄉鎮市區);
      const b2CityAns=classifyCityType(rec2.縣市), b2DistAns=classifyDistrictType(rec2.鄉鎮市區);

      let round=0;
      if(b1CitySel===b1CityAns) round+=5;
      if(b1DistSel===b1DistAns) round+=5;
      if(b2CitySel===b2CityAns) round+=5;
      if(b2DistSel===b2DistAns) round+=5;
      if(round===20) round+=10;

      currentScore+=round; scoreEl.textContent=currentScore;

      flashJudge("#block1 .city-row", b1CitySel, b1CityAns);
      flashJudge("#block1 .dist-row", b1DistSel, b1DistAns);
      flashJudge("#block2 .city-row", b2CitySel, b2CityAns);
      flashJudge("#block2 .dist-row", b2DistSel, b2DistAns);

      // 判斷是否全對
      const isAllCorrect = (round === 20 || round === 30); // 全對（四題20 +10）
      const isNotCorrect = round < 20;

// 預設先隱藏所有 boy/girl
  ["boy1","boy3","girl1","girl3"].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.classList.add("hidden");
  });

  // 切換男生角色
  if (isNotCorrect) {
    document.getElementById("boy3").classList.remove("hidden"); // 答錯
  }
  if (isAllCorrect) {
    document.getElementById("boy1").classList.remove("hidden"); // 答對
  }

// 切換女生角色（同樣邏輯）
if (isNotCorrect) {
  document.getElementById("girl3").classList.remove("hidden");
}
if (isAllCorrect) {
  document.getElementById("girl1").classList.remove("hidden"); // 答對
}

      setTimeout(()=>{
        if(timeOver) return;          // 若剛好時間到，就不再出新題
        loadNewRound(dataset);
      }, 400);
    });
  </script>
</body>
</html>
